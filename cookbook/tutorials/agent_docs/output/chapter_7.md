## Chapter 7. Other Preparation Tables

Details the creation of the remaining preparation tables used in the data pipeline:

### 7.1. sheetload_devrel_influenced_campaigns_source
    *   Source: `devrel_influenced_campaigns`
    *   Key transformations: loads and cleans DevRel influenced campaign data.

```sql
CREATE TABLE "PREP".sheetload.sheetload_devrel_influenced_campaigns_source as
WITH source AS (
  SELECT *
  FROM "RAW".sheetload.devrel_influenced_campaigns
), renamed AS (
  SELECT
    campaign_name::VARCHAR  as campaign_name,
    campaign_type::VARCHAR  as campaign_type,
    description::VARCHAR    as description,
    influence_type::VARCHAR as influence_type,
    url::VARCHAR  as url,
    dri::VARCHAR  as dri
  FROM source
)
SELECT *
FROM renamed
WHERE campaign_name IS NOT NULL;
```

### 7.2. prep_sales_territory
    *   Source: `zuora_country_geographic_region`
    *   Key transformations: cleaning and transformation of sales territory data.

```sql
CREATE TABLE "PROD".common_prep.prep_sales_territory as
WITH source_data AS (
    SELECT *
    FROM "PROD".restricted_safe_common_prep.prep_sfdc_account
    WHERE dim_parent_sales_territory_name_source IS NOT NULL
), unioned AS (
    SELECT DISTINCT
      md5(cast(coalesce(cast(dim_parent_sales_territory_name_source as TEXT), '_dbt_utils_surrogate_key_null_') as TEXT))  AS dim_sales_territory_id,
      dim_parent_sales_territory_name_source                     AS sales_territory_name
    FROM source_data
    UNION ALL
    SELECT
      MD5('-1')                                   AS dim_sales_territory_id,
      'Missing sales_territory_name'       AS sales_territory_name
)
SELECT
      *,
      '@mcooperDD'::VARCHAR       AS created_by,
      '@lisvinueza'::VARCHAR       AS updated_by,
      '2020-12-18'::DATE        AS model_created_date,
      '2023-05-21'::DATE        AS model_updated_date,
      CURRENT_TIMESTAMP()               AS dbt_updated_at,
            CURRENT_TIMESTAMP()               AS dbt_created_at
    FROM unioned;
```

### 7.3. prep_bizible_marketing_channel_path
    *   Source: `map_bizible_marketing_channel_path`
    *   Key transformations: transformation of bizible marketing channel paths data.

```sql
CREATE TABLE "PROD".common_prep.prep_bizible_marketing_channel_path as
WITH source_data AS (
    SELECT *
    FROM "PROD".common_mapping.map_bizible_marketing_channel_path
    WHERE bizible_marketing_channel_path_name_grouped IS NOT NULL
), unioned AS (
    SELECT DISTINCT
      md5(cast(coalesce(cast(bizible_marketing_channel_path_name_grouped as TEXT), '_dbt_utils_surrogate_key_null_') as TEXT))  AS dim_bizible_marketing_channel_path_id,
      bizible_marketing_channel_path_name_grouped                     AS bizible_marketing_channel_path_name
    FROM source_data
    UNION ALL
    SELECT
      MD5('-1')                                   AS dim_bizible_marketing_channel_path_id,
      'Missing bizible_marketing_channel_path_name'       AS bizible_marketing_channel_path_name
)
SELECT
      *,
      '@mcooperDD'::VARCHAR       AS created_by,
      '@mcooperDD'::VARCHAR       AS updated_by,
      '2020-12-18'::DATE        AS model_created_date,
      '2021-02-26'::DATE        AS model_updated_date,
      CURRENT_TIMESTAMP()               AS dbt_updated_at,
            CURRENT_TIMESTAMP()               AS dbt_created_at
    FROM unioned;
```

### 7.4. Zuora Order Actions
    *   Source: `orderaction`
    *   Key transformations: Transformation of Zuora order action data

```sql
CREATE TABLE "PREP".zuora_order.zuora_order_action_source as
WITH source AS (
    SELECT *
    FROM "RAW".zuora_stitch_rest_api.orderaction
), renamed AS (
    SELECT
      --Primary Keys
      id::VARCHAR                               AS order_action_id,
      --Info
      accountid::VARCHAR                        AS account_id,
      autogenerated::VARCHAR                    AS auto_generated,
      autorenew::VARCHAR                        AS auto_renew,
      billtocontactid::VARCHAR                  AS bill_to_contact_id,
      cancellationeffectivedate::TIMESTAMP_TZ   AS cancellation_effective_date,
      cancellationpolicy::VARCHAR               AS cancellation_policy,
      changereason::VARCHAR                     AS change_reason,
      clearingexistingbilltocontact::VARCHAR    AS clearing_existing_bill_to_contact,
      clearingexistingpaymentterm::VARCHAR      AS clearing_existing_payment_term,
      contracteffectivedate::TIMESTAMP_TZ       AS contract_effective_date,
      createdbyid::VARCHAR                      AS created_by_id,
      createddate::TIMESTAMP_TZ                 AS created_date,
      currentterm::VARCHAR                      AS current_term,
      currenttermperiodtype::VARCHAR            AS current_term_period_type,
      customeracceptancedate::TIMESTAMP_TZ      AS customer_acceptance_date,
      defaultpaymentmethodid::VARCHAR           AS default_payment_method_id,
      effectivepolicy::VARCHAR                  AS effective_policy,
      orderactionbilltoid::VARCHAR              AS order_action_bill_to_id,
      orderid::VARCHAR                          AS order_id,
      parentaccountid::VARCHAR                  AS parent_account_id,
      paymentterm::VARCHAR                      AS payment_term,
      renewalterm::VARCHAR                      AS renewal_term,
      renewaltermperiodtype::VARCHAR            AS renewal_term_period_type,
      renewsetting::VARCHAR                     AS renew_setting,
      sequence::VARCHAR                         AS sequence,
      serviceactivationdate::TIMESTAMP_TZ       AS service_activation_date,
      soldtocontactid::VARCHAR                  AS sold_to_contact_id,
      subscriptionid::VARCHAR                   AS subscription_id,
      subscriptionowneraccountbilltoid::VARCHAR AS subscription_owner_account_bill_to_id,
      subscriptionowneraccountid::VARCHAR       AS subscription_owner_account_id,
      subscriptionowneraccountsoldtoid::VARCHAR AS subscription_owner_account_sold_to_id,
      subscriptionversionamendmentId::VARCHAR   AS amendment_id,
      subtype::VARCHAR                          AS subtype,
      termstartdate::TIMESTAMP_TZ               AS term_start_date,
      termtype::VARCHAR                         AS term_type,
      type::VARCHAR                             AS type,
      updatedbyid::VARCHAR                      AS updated_by_id,
      updateddate::TIMESTAMP_TZ                 AS updated_date
    FROM source
)
SELECT *
FROM renamed;
```

### 7.5. Zuora Order
    *   Source: `ORDER`
    *   Key transformations: Transformation of Zuora order data

```sql
CREATE TABLE "PREP".zuora_order.zuora_order_source as
WITH source AS (
    SELECT *
    FROM "RAW".zuora_stitch_rest_api."ORDER"
), renamed AS (
    SELECT
      --Primary Keys
      id::VARCHAR                       AS order_id,
      --Info
      accountid::VARCHAR AS account_id,
      billtocontactid::VARCHAR AS bill_to_contact_id,
      createdbyid::VARCHAR AS created_by_id,
      createdbymigration::BOOLEAN AS created_by_migration,
      createddate::TIMESTAMP_TZ AS created_date,
      defaultpaymentmethodid::VARCHAR AS default_payment_method_id,
      description::VARCHAR AS description,
      orderdate::TIMESTAMP_TZ AS order_date,
      ordernumber::VARCHAR AS order_number,
      parentaccountid::VARCHAR AS parent_account_id,
      soldtocontactid::VARCHAR AS sold_to_contact_id,
      state::VARCHAR AS state,
      status::VARCHAR AS status,
      updatedbyid::VARCHAR AS updated_by_id,
      updateddate::VARCHAR AS updated_date
    FROM source
)
SELECT *
FROM renamed;
```

### 7.7. prep_pte_scores_source
    *   Source: `pte_scores`
    *   Key transformations: Transformation of PTE scores data

```sql
CREATE TABLE "PREP".data_science.pte_scores_source as
WITH source AS (
    SELECT *
    FROM "RAW".data_science.pte_scores
), intermediate AS (
    SELECT
      d.value as data_by_row,
      uploaded_at
    FROM source,
    LATERAL FLATTEN(INPUT => PARSE_JSON(jsontext), outer => true) d
), parsed AS (
    SELECT
      data_by_row['crm_account_id']::VARCHAR                AS crm_account_id,
      data_by_row['score_date']::TIMESTAMP                  AS score_date,
      data_by_row['score']::NUMBER(38,4)                    AS score,
      data_by_row['decile']::INT                            AS decile,
      data_by_row['importance']::INT                        AS importance,
      data_by_row['grouping']::INT                          AS score_group,
      data_by_row['insights']::VARCHAR                      AS insights,
      data_by_row['model_version']::FLOAT                   AS model_version,
      uploaded_at::TIMESTAMP                                AS uploaded_at,
      data_by_row['uptier_likely']::BOOLEAN                 AS uptier_likely
    FROM intermediate
)
SELECT *
FROM parsed;
```

### 7.8. prep_ptc_scores_source
    *   Source: `ptc_scores`
    *   Key transformations: Transformation of PTC scores data

```sql
CREATE TABLE "PREP".data_science.ptc_scores_source as
WITH source AS (
    SELECT *
    FROM "RAW".data_science.ptc_scores
), intermediate AS (
    SELECT
      d.value as data_by_row,
      uploaded_at
    FROM source,
    LATERAL FLATTEN(INPUT => PARSE_JSON(jsontext), outer => true) d
), parsed AS (
    SELECT
      data_by_row['crm_account_id']::VARCHAR                AS crm_account_id,
      data_by_row['score_date']::TIMESTAMP                  AS score_date,
      data_by_row['score']::NUMBER(38,4)                    AS score,
      data_by_row['decile']::INT                            AS decile,
      data_by_row['importance']::INT                        AS importance,
      data_by_row['grouping']::INT                          AS score_group,
      data_by_row['insights']::VARCHAR                      AS insights,
      data_by_row['renewal_date']::TIMESTAMP                AS renewal_date,
      data_by_row['downtier_likely']::BOOLEAN               AS downtier_likely,
      data_by_row['model_version']::FLOAT                   AS model_version,
      uploaded_at::TIMESTAMP                                AS uploaded_at
    FROM intermediate
)
SELECT *
FROM parsed;
```

### 7.9. Other Sources
    *   Source: `prep_crm_task`, `prep_crm_event`, `prep_sales_segment`, `prep_location_region`, `sfdc_account_snapshots_source`, `sfdc_user_snapshots_source`, `Zuora Rate Plan Charge`, `Marketo Lead`
    *   Key transformations: clean and format of core data

```sql
CREATE TABLE "PROD".common_prep.prep_crm_task as
WITH source AS (
    SELECT *
    FROM "PREP".sfdc.sfdc_task_source
), renamed AS(
    SELECT
      task_id,
      --keys
      md5(cast(coalesce(cast(source.task_id as TEXT), '_dbt_utils_surrogate_key_null_') as TEXT))             AS dim_crm_task_sk,
      source.task_id                                                AS dim_crm_task_pk,
      source.account_id                                             AS dim_crm_account_id,
      source.owner_id                                               AS dim_crm_user_id,
      source.assigned_employee_number,
      source.lead_or_contact_id,
      source.account_or_opportunity_id,
      source.record_type_id                                         AS sfdc_record_type_id,
      source.related_to_account_name,
      source.related_lead_id,
      source.related_contact_id,
      source.related_opportunity_id                                 AS dim_crm_opportunity_id,
      source.related_account_id,
      source.related_to_id,
      COALESCE(source.related_lead_id, source.related_contact_id)   AS sfdc_record_id,
      -- Task infomation
      source.comments,
      source.full_comments,
      source.task_subject,
      source.partner_marketing_task_subject,
      source.task_date,
      source.task_created_at                                        AS task_created_date,
      FIRST_VALUE(source.task_created_at) OVER (PARTITION BY source.related_opportunity_id ORDER BY source.task_created_at ASC) AS first_opportunity_task_created_date,
      source.task_created_by_id,
      source.task_status,
      source.task_subtype,
      source.task_type,
      source.task_priority,
      source.close_task,
      source.task_completed_at                                      AS task_completed_date,
      source.is_closed,
      source.is_deleted,
      source.is_archived,
      source.is_high_priority,
      source.persona_functions,
      source.persona_levels,
      source.outreach_meeting_type,
      source.customer_interaction_sentiment,
      source.task_owner_role,
      source.is_created_by_groove,
      -- Activity infromation
      source.activity_disposition,
      source.activity_source,
      source.csm_activity_type,
      source.sa_activity_type,
      source.gs_activity_type,
      source.gs_sentiment,
      source.gs_meeting_type,
      source.is_gs_exec_sponsor_present,
      source.is_meeting_cancelled,
      source.products_positioned,
      -- Call information
      source.call_type,
      source.call_purpose,
      source.call_disposition,
      source.call_duration_in_seconds,
      source.call_recording,
      source.is_answered,
      source.is_correct_contact,
      -- Reminder information
      source.is_reminder_set,
      source.reminder_at                                            AS reminder_date,
      -- Recurrence information
      source.is_recurrence,
      source.task_recurrence_interval,
      source.task_recurrence_instance,
      source.task_recurrence_type,
      source.task_recurrence_activity_id,
      source.task_recurrence_end_date                               AS task_recurrence_date,
      source.task_recurrence_day_of_week,
      source.task_recurrence_timezone,
      source.task_recurrence_start_date,
      source.task_recurrence_day_of_month,
      source.task_recurrence_month,
      -- Sequence information
      source.active_sequence_name,
      source.sequence_step_number,
      -- Docs/Video Conferencing
      source.google_doc_link,
      source.zoom_app_ics_sequence,
      source.zoom_app_use_personal_zoom_meeting_id,
      source.zoom_app_join_before_host,
      source.zoom_app_make_it_zoom_meeting,
      source.chorus_call_id,
      -- Counts
      source.account_or_opportunity_count,
      source.lead_or_contact_count,
      -- metadata
      source.last_modified_id,
      source.last_modified_at                                                                           AS last_modified_date,
      source.system_modified_at                                                                         AS systemmodstamp,
      -- flags
      IFF(
        source.task_subject LIKE '%Reminder%',
          1,
        0
        )                                                                                               AS is_reminder_task,
      IFF(
        source.task_status = 'Completed',
          1,
        0
        )                                                                                               AS is_completed_task,
      IFF(
        source.owner_id != '0054M000004M9pdQAC',
          1,
        0
        )                                                                                               AS is_gainsight_integration_user_task,
      IFF(
        source.task_type ='Demand Gen'
          OR LOWER(source.task_subject) LIKE '%demand gen%'
            OR LOWER(source.full_comments) LIKE '%demand gen%',
          1,
        0
        )                                                                                               AS is_demand_gen_task,
       IFF(
        source.task_type ='Demo'
          OR LOWER(source.task_subject) LIKE '%demo%'
            OR LOWER(source.full_comments) LIKE '%demo%',
           1,
        0
        )                                                                                                AS is_demo_task,
       IFF(
        source.task_type ='Workshop'
          OR LOWER(source.task_subject) LIKE '%workshop%'
            OR LOWER(source.full_comments) LIKE '%workshop%',
          1,
        0
        )                                                                                                AS is_workshop_task,
      IFF(
        source.task_type LIKE '%meeting%'
          OR LOWER(source.task_subject) LIKE '%meeting%'
            OR LOWER(source.full_comments) LIKE '%meeting%',
          1,
        0
        )                                                                                               AS is_meeting_task,
      IFF(
        (
        source.task_type='Email'
          AND LOWER(source.task_subject) LIKE '%[email] [out]%'
          )
            OR (
                source.task_type ='Other'
                  AND LOWER(source.task_subject) LIKE '%email sent%'
                  ),
          1,
        0
        )                                                                                               AS is_email_task,
      IFF(
        source.task_subject LIKE '%[In]%',
          1,
         0
         )                                                                                              AS is_incoming_email_task,
      IFF(
        source.task_subject LIKE '%[Out]%',
          1,
         0
         )                                                                                              AS is_outgoing_email_task,
      IFF(
        is_email_task = 1
          AND LOWER(source.task_priority) ='high',
          1,
        0
        )                                                                                               AS is_high_priority_email_task,
      IFF(
        is_email_task = 1
          AND LOWER(source.task_priority) ='low',
            1,
          0
          )                                                                                             AS is_low_priority_email_task,
       IFF(
        is_email_task = 1
          AND LOWER(source.task_priority) ='normal',
            1,
          0
          )                                                                                             AS is_normal_priority_email_task,
        IFF(
          source.task_type='Call'
            OR source.task_subtype ='Call',
            1,
          0
          )                                                                                             AS is_call_task,
        IFF(
          is_call_task = 1
            AND source.call_duration_in_seconds >= 60,
            1,
          0
          )                                                                                             AS is_call_longer_1min_task,
        IFF(
          is_call_task = 1
            AND lower(source.task_priority) ='high',
            1,
          0
          )                                                                                             AS is_high_priority_call_task,
        IFF(
          is_call_task = 1
            AND lower(source.task_priority) ='low',
            1,
          0
          )                                                                                             AS is_low_priority_call_task,
        IFF(
          is_call_task = 1
            AND lower(source.task_priority) ='normal',
            1,
          0
          )                                                                                             AS is_normal_priority_call_task,
        IFF(
          is_call_task = 1
            AND (
                 source.call_disposition IN (
                                            'Not Answered','Correct Contact: Not Answered/Other','Call - No Answer','No Number Found','Busy',
                                            'Bad Number','Automated Switchboard','Incorrect Contact: Left Message','Not Answered (legacy)',
                                            'Incorrect Contact: Not Answered/Other','Main Company Line - Can''t Transfer Line','',' '
                                            )
                  OR source.call_disposition IS NULL
                  ),
            1,
          0
          )                                                                                             AS is_not_answered_call_task,
        IFF(
          is_call_task = 1
            AND source.call_disposition IN (
                                            'CC: Answered: Info Gathered: Not Opp yet',
                                            'CC: Answered: Not Interested','Incorrect Contact: Answered','CC: Answered: Personal Use'
                                            ),
            1,
          0
          )                                                                                             AS is_answered_meaningless_call_task,
        IFF(
          is_call_task = 1
            AND source.call_disposition IN (
                                            'CC:Answered: Info Gathered: Potential Opp',
                                            'Correct Contact: Answered','CC: Answered: Asked for Call Back','Correct Contact: IQM Set',
                                            'Correct Contact: Discovery Call Set','CC: Answered: Using Competition','Incorrect Contact: Answered: Gave Referral',
                                            'Correct Contact: Answered (Do not use)','Answered (legacy)'
                                            ),
            1,
          0
          )                                                                                             AS is_answered_meaningfull_call_task,
        IFF(
          is_email_task = 1
            AND source.task_created_at = first_opportunity_task_created_date,
            1,
          0
          )                                                                                             AS is_opportunity_initiation_email_task,
        IFF(
          is_email_task = 1
            AND source.task_created_at != first_opportunity_task_created_date,
              1,
            0
            )                                                                                           AS is_opportunity_followup_email_task,
        IFF(
          is_call_task = 1
            AND  source.task_created_at = first_opportunity_task_created_date,
            1,
          0
          )                                                                                             AS is_opportunity_initiation_call_task,
        IFF(
          is_call_task = 1
            AND  source.task_created_at != first_opportunity_task_created_date,
            1,
          0
          )                                                                                             AS is_opportunity_followup_call_task,
      -- Calculated averaged and percents
       DATEDIFF(hour, source.task_date, source.task_created_at)                                       AS hours_waiting_before_task,
       ROUND(
        IFF(
            is_email_task = 1,
              hours_waiting_before_task,
            NULL
            ),
          1)                                                                                            AS hours_waiting_before_email_task,
       ROUND(
         IFF(
           is_call_task = 1,
             source.call_duration_in_seconds,
           NULL
           ),
        0
        )                                                                                              AS call_task_duration_in_seconds,
       ROUND(
         IFF(
           is_call_task = 1,
             hours_waiting_before_task,
           NULL
           ),
        1)                                                                                              AS hours_waiting_before_call_task
    FROM source
)
SELECT *
FROM renamed;
```

```sql
CREATE TABLE "PROD".common_prep.prep_crm_event as
WITH source AS (
    SELECT *
    FROM "PREP".sfdc.sfdc_event_source
), renamed AS(
    SELECT
      event_id,
    --keys
      md5(cast(coalesce(cast(source.event_id as TEXT), '_dbt_utils_surrogate_key_null_') as TEXT))            AS dim_crm_event_sk,
      source.event_id                                               AS dim_crm_event_pk,
      source.account_id                                             AS dim_crm_account_id,
      source.owner_id                                               AS dim_crm_user_id,
      source.lead_or_contact_id,
      source.related_account_name,
      source.related_lead_id,
      source.related_contact_id,
      source.related_opportunity_id                                 AS dim_crm_opportunity_id,
      source.related_account_id,
      source.related_to_id,
      source.created_by_id,
      source.booked_by_dim_crm_user_id,
      source.what_id,
      COALESCE(source.related_lead_id, source.related_contact_id)   AS sfdc_record_id,
    -- Task infomation
      source.event_subject,
      source.event_source,
      source.outreach_meeting_type,
      source.event_type,
      source.event_disposition,
      source.event_description,
      source.event_subtype,
      source.booked_by_employee_number,
      source.sa_activity_type,
      source.event_show_as,
      source.assigned_to_role,
      source.csm_activity_type,
      source.customer_interaction_sentiment,
      source.google_doc_link,
      source.comments,
      source.qualified_convo_or_meeting,
      FIRST_VALUE(source.created_at) OVER (PARTITION BY source.related_opportunity_id ORDER BY source.created_at ASC) AS first_opportunity_event_created_date,
      source.partner_marketing_task_subject,
    --Dates and Datetimes
      source.event_start_date_time,
      source.reminder_date_time,
      source.event_end_date_time,
      source.event_date,
      source.event_date_time,
      source.created_at,
      source.event_end_date,
    --Event Flags
      source.is_all_day_event,
      source.is_archived,
      source.is_child_event,
      source.is_group_event,
      source.is_private_event,
      source.is_recurrence,
      source.has_reminder_set,
      source.is_answered,
      source.is_correct_contact,
      source.is_meeting_canceled,
      source.is_closed_event,
    --Recurrence Info
      source.event_recurrence_activity_id,
      source.event_recurrence_day_of_week,
      source.event_recurrence_day_of_month,
      source.event_recurrence_end_date,
      source.event_recurrence_instance,
      source.event_recurrence_interval,
      source.event_recurrence_month_of_year,
      source.event_recurrence_start_date_time,
      source.event_recurrence_timezone_key,
      source.event_recurrence_type,
      source.is_recurrence_2_exclusion,
      source.is_recurrence_2,
      source.is_recurrence_2_exception,
      -- metadata
      source.last_modified_id,
      source.last_modified_date,
      source.systemmodstamp,
      source.is_deleted
    FROM source
)
SELECT *
FROM renamed;
```

```sql
CREATE TABLE "PROD".common.dim_sales_segment as
WITH sales_segment AS (
    SELECT
      dim_sales_segment_id,
      sales_segment_name,
      sales_segment_grouped
    FROM "PROD".common_prep.prep_sales_segment
)
SELECT
      *,
      '@msendal'::VARCHAR       AS created_by,
      '@jpeguero'::VARCHAR       AS updated_by,
      '2020-11-05'::DATE        AS model_created_date,
      '2020-04-26'::DATE        AS model_updated_date,
      CURRENT_TIMESTAMP()               AS dbt_updated_at,
            CURRENT_TIMESTAMP()               AS dbt_created_at
    FROM sales_segment;
```

```sql
CREATE TABLE "PROD".common_prep.prep_location_region as
WITH source_data AS (
    SELECT *
    FROM "PREP".sfdc.sfdc_users_source
    WHERE user_geo IS NOT NULL
), unioned AS (
    SELECT DISTINCT
      md5(cast(coalesce(cast(user_geo as TEXT), '_dbt_utils_surrogate_key_null_') as TEXT))  AS dim_location_region_id,
      user_geo                     AS location_region_name
    FROM source_data
    UNION ALL
    SELECT
      MD5('-1')                                   AS dim_location_region_id,
      'Missing location_region_name'       AS location_region_name
)
SELECT
      *,
      '@mcooperDD'::VARCHAR       AS created_by,
      '@mcooperDD'::VARCHAR       AS updated_by,
      '2021-01-25'::DATE        AS model_created_date,
      '2021-01-25'::DATE        AS model_updated_date,
      CURRENT_TIMESTAMP()               AS dbt_updated_at,
            CURRENT_TIMESTAMP()               AS dbt_created_at
    FROM unioned;
```

```sql
CREATE TABLE "PROD".legacy.sfdc_account_snapshots_source as
WITH source AS (
  SELECT *
  FROM "RAW".snapshots.sfdc_account_snapshots
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY
      dbt_valid_from::DATE,
      id
    ORDER BY dbt_valid_from DESC
  ) = 1
),
/*
  ATTENTION: When a field is added to this snapshot model, add it to the SFDC_ACCOUNT_SOURCE model to keep the live and snapshot models in alignment.
*/
renamed AS (
  SELECT
    id                                                                                AS account_id,
    name                                                                              AS account_name,
    -- keys
    account_id_18__c                                                                  AS account_id_18,
    masterrecordid                                                                    AS master_record_id,
    ownerid                                                                           AS owner_id,
    parentid                                                                          AS parent_id,
    primary_contact_id__c                                                             AS primary_contact_id,
    recordtypeid                                                                      AS record_type_id,
    ultimate_parent_account_id__c                                                     AS ultimate_parent_id,
    ultimate_parent_account_text__c                                                   AS ultimate_parent_account_name,
    partner_vat_tax_id__c                                                             AS partner_vat_tax_id,
    -- key people GL side
    gitlab_com_user__c                                                                AS gitlab_com_user,
    account_manager__c                                                                AS account_manager,
    account_owner_calc__c                                                             AS account_owner,
    account_owner_team__c                                                             AS account_owner_team,
    account_owner_role__c                                                             AS account_owner_role,
    proposed_account_owner__c                                                         AS proposed_account_owner,
    business_development_rep__c                                                       AS crm_business_dev_rep_id,
    dedicated_service_engineer__c                                                     AS dedicated_service_engineer,
    sdr_assigned__c                                                                   AS crm_sales_dev_rep_id,
    -- solutions_architect__c                     AS solutions_architect,
    technical_account_manager_lu__c                                                   AS technical_account_manager_id,
    executive_sponsor__c                                                              AS executive_sponsor_id,
    -- info
    "PROD".preparation.ID15TO18(SUBSTRING(REGEXP_REPLACE(
      ultimate_parent_account__c, '_HL_ENCODED_/|<a\\s+href="/', ''
    ), 0, 15))                                                                        AS ultimate_parent_account_id,
    type                                                                              AS account_type,
    dfox_industry__c                                                                  AS df_industry,
    parent_lam_industry_acct_heirarchy__c                                             AS industry,
    sub_industry__c                                                                   AS sub_industry,
    parent_lam_industry_acct_heirarchy__c                                             AS parent_account_industry_hierarchy,
    account_tier__c                                                                   AS account_tier,
    account_tier_notes__c                                                             AS account_tier_notes,
    customer_since__c::DATE                                                           AS customer_since_date,
    carr_this_account__c                                                              AS carr_this_account,
    carr_acct_family__c                                                               AS carr_account_family,
    next_renewal_date__c                                                              AS next_renewal_date,
    license_utilization__c                                                            AS license_utilization,
    support_level__c                                                                  AS support_level,
    named_account__c                                                                  AS named_account,
    billingcountry                                                                    AS billing_country,
    account_demographics_upa_country__c                                               AS billing_country_code,
    billingpostalcode